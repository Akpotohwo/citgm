#!/usr/local/bin/node
'use strict';

var citgm = require('../lib/citgm');
var app = require('commander');
var util = require('util');

var mod;
var test;
app
  .version('0.0.1')
  .arguments('<module> [test]')
  .action(function(m, t) {
    mod = m;
    test = t;
  })
  .option(
    '-v, --verbose', 'Verbose output')
  .option(
    '-r, --reporter <path>',
    'A reporter script');

if (process.platform !== 'win32') {
  app.option(
    '-u, --uid <uid>', 'Set the numeric uid (posix only)', parseInt
  )
  .option(
    '-g, --gid <uid>', 'Set the numeric gid (posix only)', parseInt
  );
}

app.parse(process.argv);

if (!mod) {
  app.outputHelp();
  return;
}

var options = {
  script: test,
  reporter: app.reporter
};
if (process.platform !== 'win32') {
  if (app.uid) options.uid = app.uid;
  if (app.gid) options.gid = app.gid;
}

citgm.Tester(mod, options)
.on('start', function(name, options) {
  console.log(util.format('Starting [%s]', name));
}).on('fail', function(err) {
  console.log('Failure...', err);
  process.exitCode = 1;
}).on('info', function(key,message) {
  if (app.verbose)
    console.log('Info:', key, message);
}).on('end', function(name) {
  console.log(util.format('Done [%s]', name));
}).run();
